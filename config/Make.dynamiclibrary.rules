# **********************************************************************
#
# Copyright (c) 2003-2015 ZeroC, Inc. All rights reserved.
#
# This copy of Ice is licensed to you under the terms described in the
# ICE_LICENSE file included in this distribution.
#
# **********************************************************************

include $(OBJECT_RULES)

LOCAL_LIBFILENAME	= $(call mksoname,$(LOCAL_LIB),$(VERSION))
LOCAL_LIBNAME		= $(call mksoname,$(LOCAL_LIB),$(SOVERSION))
LOCAL_SONAME		= $(call mksoname,$(LOCAL_LIB))

ifeq ($(LOCAL_LIBDIR),)
LOCAL_LIBDIR		= $(libdir)
endif

ifneq ($(LOCAL_LINK_WITH),)
LOCAL_LDFLAGS += $(addprefix -l,$(LOCAL_LINK_WITH))
endif

$(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME): LOCAL_LIBDIR := $(LOCAL_LIBDIR)
$(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME): LOCAL_LIBFILENAME := $(LOCAL_LIBFILENAME)
$(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME): LOCAL_LIBNAME := $(LOCAL_LIBNAME)
$(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME): LOCAL_OBJS := $(LOCAL_OBJS)
$(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME): LOCAL_LDFLAGS := $(LOCAL_LDFLAGS)

$(LOCAL_LIBDIR)/$(LOCAL_LIBNAME): LOCAL_LIBDIR := $(LOCAL_LIBDIR)
$(LOCAL_LIBDIR)/$(LOCAL_LIBNAME): LOCAL_LIBNAME := $(LOCAL_LIBNAME)
$(LOCAL_LIBDIR)/$(LOCAL_LIBNAME): LOCAL_LIBFILENAME := $(LOCAL_LIBFILENAME)

$(LOCAL_LIBDIR)/$(LOCAL_SONAME): LOCAL_LIBDIR := $(LOCAL_LIBDIR)
$(LOCAL_LIBDIR)/$(LOCAL_SONAME): LOCAL_LIBNAME := $(LOCAL_LIBNAME)
$(LOCAL_LIBDIR)/$(LOCAL_SONAME): LOCAL_SONAME := $(LOCAL_SONAME)

$(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME): $(LOCAL_OBJS) $(foreach lib,$(LOCAL_LINK_WITH),$(libdir)/lib$(lib).a)
	@mkdir -p $(@D)
	$(E) Creating library: $(@F)
	$(Q)$(call mkshlib,$@,$(LOCAL_LIBNAME),$(LOCAL_OBJS),$(LOCAL_LDFLAGS))

$(LOCAL_LIBDIR)/$(LOCAL_LIBNAME): $(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME)
	$(E) Creating library: $(@F)
	$(Q)cd $(LOCAL_LIBDIR) && ln -s $(LOCAL_LIBFILENAME) $(LOCAL_LIBNAME)

$(LOCAL_LIBDIR)/$(LOCAL_SONAME): $(LOCAL_LIBDIR)/$(LOCAL_LIBNAME)
	$(E) Creating library: $(@F)
	$(Q)cd $(LOCAL_LIBDIR) && ln -s $(LOCAL_LIBNAME) $(LOCAL_SONAME)

$(LOCAL_MODULE): LOCAL_LIBDIR := $(LOCAL_LIBDIR)
$(LOCAL_MODULE): LOCAL_LIBFILENAME := $(LOCAL_LIBFILENAME)
$(LOCAL_MODULE): LOCAL_LIBNAME := $(LOCAL_LIBNAME)
$(LOCAL_MODULE): LOCAL_SONAME := $(LOCAL_SONAME)

$(LOCAL_MODULE): $(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME) $(LOCAL_LIBDIR)/$(LOCAL_LIBNAME) $(LOCAL_LIBDIR)/$(LOCAL_SONAME)


$(LOCAL_MODULE)_clean: LOCAL_LIBDIR := $(LOCAL_LIBDIR)
$(LOCAL_MODULE)_clean: LOCAL_LIBFILENAME := $(LOCAL_LIBFILENAME)
$(LOCAL_MODULE)_clean: LOCAL_LIBNAME := $(LOCAL_LIBNAME)
$(LOCAL_MODULE)_clean: LOCAL_SONAME := $(LOCAL_SONAME)

$(LOCAL_MODULE)_clean::
	$(Q)rm -rf $(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME) $(LOCAL_LIBDIR)/$(LOCAL_LIBNAME) $(LOCAL_LIBDIR)/$(LOCAL_SONAME)

TARGETS := $(TARGETS) $(LOCAL_LIBDIR)/$(LOCAL_LIBFILENAME) $(LOCAL_LIBDIR)/$(LOCAL_LIBNAME) $(LOCAL_LIBDIR)/$(LOCAL_SONAME)