# **********************************************************************
#
# Copyright (c) 2003-2015 ZeroC, Inc. All rights reserved.
#
# This copy of Ice is licensed to you under the terms described in the
# ICE_LICENSE file included in this distribution.
#
# **********************************************************************

include $(OBJECT_RULES)

ifneq ($(LOCAL_LINK_WITH),)
LOCAL_LDFLAGS += $(addprefix -l,$(LOCAL_LINK_WITH))
endif

ifeq ($(LOCAL_BINDIR),)
LOCAL_BINDIR	= $(bindir)
endif

$(LOCAL_MODULE): LOCAL_BINDIR := $(LOCAL_BINDIR)
$(LOCAL_MODULE): LOCAL_EXE := $(LOCAL_EXE)


$(LOCAL_BINDIR)/$(LOCAL_EXE): LOCAL_MODULE := $(LOCAL_MODULE)
$(LOCAL_BINDIR)/$(LOCAL_EXE): LOCAL_BINDIR := $(LOCAL_BINDIR)
$(LOCAL_BINDIR)/$(LOCAL_EXE): LOCAL_EXE := $(LOCAL_EXE)
$(LOCAL_BINDIR)/$(LOCAL_EXE): LOCAL_OBJS := $(LOCAL_OBJS)
$(LOCAL_BINDIR)/$(LOCAL_EXE): LOCAL_LINK_WITH := $(LOCAL_LINK_WITH)
$(LOCAL_BINDIR)/$(LOCAL_EXE): LOCAL_LDFLAGS := $(LOCAL_LDFLAGS)

$(LOCAL_MODULE)_clean: LOCAL_OBJS := $(LOCAL_OBJS)
$(LOCAL_MODULE)_clean: LOCAL_EXE := $(LOCAL_EXE)
$(LOCAL_MODULE)_clean: LOCAL_BINDIR := $(LOCAL_BINDIR)

ifneq ($(USE_BIN_DIST),yes)
$(LOCAL_BINDIR)/$(LOCAL_EXE): $(foreach lib,$(LOCAL_LINK_WITH),$(libdir)/lib$(lib).a)
endif

$(LOCAL_BINDIR)/$(LOCAL_EXE): $(LOCAL_OBJS)
	@mkdir -p $(@D)
	@rm -rf $(@)
	$(E) "Linking $(LOCAL_MODULE)"
	$(Q)$(CXX) -o $(@) $(LOCAL_OBJS) -Wl,-Bstatic $(LOCAL_LDFLAGS) $(LDFLAGS) $(EXELDFLAGS)
	$(Q)$(STRIP) --strip-all --remove-section=.comment --remove-section=.note $(@)

$(LOCAL_MODULE): $(LOCAL_BINDIR)/$(LOCAL_EXE)


$(LOCAL_MODULE)_clean::
	$(Q)rm -rf $(LOCAL_BINDIR)/$(LOCAL_EXE)

TARGETS := $(TARGETS) $(LOCAL_BINDIR)/$(LOCAL_EXE)

LOCAL_RESOURCES	:= $(patsubst $(LOCAL_SRCDIR)/%,$(LOCAL_PATH)/%,$(wildcard $(addprefix $(LOCAL_SRCDIR)/,$(LOCAL_RESOURCES))))

$(LOCAL_MODULE)_gitignore: LOCAL_BINDIR := $(LOCAL_BINDIR)
$(LOCAL_MODULE)_gitignore: LOCAL_EXE := $(LOCAL_EXE)
$(LOCAL_MODULE)_gitignore: LOCAL_RESOURCES := $(LOCAL_RESOURCES)

$(LOCAL_MODULE)_gitignore::
	@echo $(LOCAL_BINDIR)/$(LOCAL_EXE)
	@for file in $(LOCAL_RESOURCES) ; do \
	    echo $$file ; \
	done

gitignore:: $(LOCAL_MODULE)_gitignore

ifneq ($(LOCAL_RESOURCES),)

$(LOCAL_MODULE)_clean: LOCAL_RESOURCES := $(LOCAL_RESOURCES)

TARGETS := $(TARGETS) $(LOCAL_RESOURCES)

$(LOCAL_PATH)/%: $(LOCAL_SRCDIR)/%
	@mkdir -p $(@D)
	$(E) Copying resource $(@F)
	$(Q)cp $< $@

$(LOCAL_MODULE)_clean::
	$(Q) rm -rf $(LOCAL_RESOURCES)
endif
